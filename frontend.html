<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lab: State + Ghi & Upload Video</title>

  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --border: #1e293b;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, .12);
      --danger: #f97373;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-soft: 0 16px 40px rgba(15, 23, 42, .8);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      padding: 24px 16px 40px;
      background:
        radial-gradient(circle at top, #1f2937 0, #020617 55%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 1120px;
    }

    h1 {
      margin: 0 0 6px;
      font-size: clamp(1.6rem, 3vw, 2.1rem);
      letter-spacing: .03em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge {
      font-size: .78rem;
      padding: 2px 10px 3px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .5);
      background: var(--accent-soft);
      color: var(--accent);
    }

    .subtitle {
      margin: 0 0 24px;
      font-size: .9rem;
      color: var(--text-muted);
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 20px;
    }

    @media (max-width: 880px) {
      body {
        padding-top: 18px;
      }
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      position: relative;
      background: var(--bg-elevated);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 16px;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0 0, rgba(56, 189, 248, .12) 0, transparent 55%),
        radial-gradient(circle at 100% 0, rgba(129, 140, 248, .12) 0, transparent 50%);
      opacity: .9;
      pointer-events: none;
      z-index: -1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .card-caption {
      font-size: .78rem;
      color: var(--text-muted);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 14px;
    }

    button {
      font: inherit;
      padding: 8px 13px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .55);
      background: radial-gradient(circle at top, #1e293b 0, #020617 80%);
      color: var(--text-main);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        background .18s ease,
        border-color .18s ease,
        transform .08s ease,
        box-shadow .18s ease;
      box-shadow: 0 0 0 rgba(56, 189, 248, 0);
      white-space: nowrap;
    }

    button span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: rgba(148, 163, 184, .9);
    }

    button.primary {
      border-color: rgba(56, 189, 248, .8);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, .1);
    }

    button.danger {
      border-color: rgba(239, 68, 68, .85);
      color: #fecaca;
    }

    button:enabled:hover {
      background: radial-gradient(circle at top, #1f2937 0, #020617 85%);
      border-color: rgba(191, 219, 254, .9);
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(15, 23, 42, .9);
    }

    button:disabled {
      opacity: .45;
      cursor: not-allowed;
      box-shadow: none;
    }

    button:active:enabled {
      transform: translateY(0);
      box-shadow: 0 6px 14px rgba(15, 23, 42, .9);
    }

    .state-display {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, .95) 0, #020617 55%);
      border-radius: var(--radius-md);
      border: 1px solid rgba(30, 64, 175, .7);
      padding: 10px 11px 9px;
      font-size: .86rem;
      white-space: pre-wrap;
      color: #e5e7eb;
    }

    .state-display .label {
      color: #9ca3af;
    }

    .state-display .value-accent {
      color: var(--accent);
      font-weight: 600;
    }

    .state-display .value-ok {
      color: #4ade80;
      font-weight: 600;
    }

    .state-display .value-bad {
      color: var(--danger);
      font-weight: 600;
    }

    .video-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 1fr);
      gap: 14px;
      margin-top: 10px;
    }

    @media (max-width: 640px) {
      .video-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .video-block h3 {
      margin: 0 0 6px;
      font-size: .9rem;
      font-weight: 500;
      color: var(--text-muted);
    }

    video {
      width: 100%;
      max-width: 100%;
      background: #000;
      border-radius: var(--radius-md);
      border: 1px solid rgba(30, 64, 175, .8);
    }

    .mirrored {
      transform: scaleX(-1);
    }

    .download-links {
      margin-top: 6px;
      font-size: .85rem;
    }

    .download-links a {
      color: var(--accent);
      text-decoration: none;
    }

    .download-links a:hover {
      text-decoration: underline;
    }

    .log {
      margin-top: 18px;
      font-size: .78rem;
      background: #020617;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 8px 10px;
      white-space: pre-wrap;
      max-height: 220px;
      overflow-y: auto;
    }

    .log-title {
      font-weight: 500;
      font-size: .8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .log-content {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>
      State + Ghi Video
      <span class="badge">Demo Lab</span>
    </h1>
    <p class="subtitle">
      State hiển thị: <strong>đang ở câu số mấy</strong>, <strong>đã trả lời câu nào</strong>, và
      <strong>có cho phép ghi lại hay không</strong>. Việc cho phép ghi được liên kết trực tiếp với nút
      <em>&quot;Bắt đầu ghi&quot;</em>.
    </p>

    <div class="grid">
      <!-- PANEL STATE -->
      <section class="card">
        <header class="card-header">
          <div class="card-title">Trạng thái câu hỏi (state.js)</div>
          <div class="card-caption">Điều khiển state &amp; quyền ghi video</div>
        </header>

        <div class="btn-row">
          <button id="btnPrevQ">
            <span class="dot"></span>
            Câu trước
          </button>
          <button id="btnNextQ">
            <span class="dot"></span>
            Câu sau
          </button>
          <button id="btnMarkAnswered">
            <span class="dot"></span>
            Đánh dấu đã trả lời
          </button>
          <button id="btnToggleRecord" class="primary">
            <span class="dot"></span>
            Toggle cho phép ghi
          </button>
          <button id="btnResetState" class="danger">
            <span class="dot"></span>
            Reset state
          </button>
        </div>

        <div id="stateDisplay" class="state-display">
          Đang tải state...
        </div>
      </section>

      <!-- PANEL VIDEO -->
      <section class="card">
        <header class="card-header">
          <div class="card-title">Ghi &amp; upload video</div>
          <div class="card-caption">Nút &quot;Bắt đầu ghi&quot; chỉ hoạt động khi state cho phép</div>
        </header>

        <div class="btn-row">
          <button id="btnInit">
            <span class="dot"></span>
            1) Xin quyền camera
          </button>
          <button id="btnFlip" disabled>
            <span class="dot"></span>
            Đổi camera trước/sau
          </button>
          <button id="btnStart" class="primary" disabled>
            <span class="dot"></span>
            2) Bắt đầu ghi
          </button>
          <button id="btnStop" class="danger" disabled>
            <span class="dot"></span>
            3) Dừng ghi
          </button>
          <button id="btnUpload" disabled>
            <span class="dot"></span>
            4) Upload server
          </button>
        </div>

        <div class="video-grid">
          <div class="video-block">
            <h3>Preview (đang quay)</h3>
            <video id="preview" autoplay muted playsinline></video>
          </div>

          <div class="video-block">
            <h3>Video đã ghi</h3>
            <video id="playback" controls></video>
            <div id="downloadLink" class="download-links"></div>
          </div>
        </div>
      </section>
    </div>

    <section class="log" aria-label="Console log">
      <div class="log-title">Log</div>
      <div id="log" class="log-content">[--] Khởi động trang...</div>
    </section>
  </div>

  <script>
    // -----------------------------
    // Helpers
    // -----------------------------
    const logEl = document.getElementById("log");
    const log = (message) => {
      const time = new Date().toLocaleTimeString();
      logEl.textContent = `[${time}] ${message}\n` + logEl.textContent;
    };

    // -----------------------------
    // State logic (state.js)
    // -----------------------------
    const TOTAL_QUESTIONS = 5;

    const quizState = {
      currentQuestionIndex: 0,
      answeredQuestions: new Set(),
      isRecordingAllowed: false,

      getState() {
        return {
          currentQuestionIndex: this.currentQuestionIndex,
          answeredQuestions: Array.from(this.answeredQuestions).sort((a, b) => a - b),
          totalQuestions: TOTAL_QUESTIONS,
          isRecordingAllowed: this.isRecordingAllowed
        };
      },

      nextQuestion() {
        if (this.currentQuestionIndex < TOTAL_QUESTIONS - 1) {
          this.currentQuestionIndex++;
        } else {
          log("State: Đã ở câu cuối cùng.");
        }
        this.notifyUpdate();
      },

      prevQuestion() {
        if (this.currentQuestionIndex > 0) {
          this.currentQuestionIndex--;
        } else {
          log("State: Đã ở câu đầu tiên.");
        }
        this.notifyUpdate();
      },

      markCurrentAsAnswered() {
        this.answeredQuestions.add(this.currentQuestionIndex);
        log(
          `State: Đã đánh dấu câu ${this.currentQuestionIndex + 1}. ` +
          `Tổng số câu đã trả lời: ${this.answeredQuestions.size}`
        );
        this.notifyUpdate();
      },

      setRecordingPermission(allowed) {
        this.isRecordingAllowed = Boolean(allowed);
        log(`State: Cho phép ghi? ${this.isRecordingAllowed ? "CÓ" : "KHÔNG"}`);
        this.notifyUpdate();
      },

      toggleRecordingPermission() {
        this.setRecordingPermission(!this.isRecordingAllowed);
      },

      reset() {
        this.currentQuestionIndex = 0;
        this.answeredQuestions.clear();
        this.isRecordingAllowed = false;
        log("State: Đã reset về mặc định.");
        this.notifyUpdate();
      },

      notifyUpdate() {
        updateStateDisplay();
        syncRecordingButton();
      }
    };

    // -----------------------------
    // State UI
    // -----------------------------
    const stateDisplay = document.getElementById("stateDisplay");

    const renderAnsweredList = (answered) => {
      if (!answered.length) return "Chưa có";
      return answered.map((q) => q + 1).join(", ");
    };

    const updateStateDisplay = () => {
      const state = quizState.getState();
      const answeredText = renderAnsweredList(state.answeredQuestions);

      const canRecord = state.isRecordingAllowed;
      const permissionText = canRecord ? "CÓ – được phép ghi" : "KHÔNG – chưa được phép ghi";

      const permissionClass = canRecord ? "value-ok" : "value-bad";

      // Dùng template HTML nhỏ để có màu sắc
      stateDisplay.innerHTML =
        `<span class="label">Đang ở câu: </span>` +
        `<span class="value-accent">${state.currentQuestionIndex + 1}</span>` +
        ` / ${state.totalQuestions}\n` +
        `<span class="label">Đã trả lời: </span>${answeredText}\n` +
        `<span class="label">Cho phép ghi?: </span>` +
        `<span class="${permissionClass}">${permissionText}</span>`;
    };

    // -----------------------------
    // Video & recording
    // -----------------------------
    const btnInit = document.getElementById("btnInit");
    const btnFlip = document.getElementById("btnFlip");
    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");
    const btnUpload = document.getElementById("btnUpload");
    const preview = document.getElementById("preview");
    const playback = document.getElementById("playback");
    const downloadLink = document.getElementById("downloadLink");

    let mediaStream = null;
    let mediaRecorder = null;
    let chunks = [];
    let recordedBlob = null;
    let useFrontCamera = true;

    const syncRecordingButton = () => {
      const { isRecordingAllowed } = quizState.getState();
      const canStart = Boolean(mediaStream) && isRecordingAllowed && btnStop.disabled;
      btnStart.disabled = !canStart;
    };

    const initCamera = async () => {
      if (mediaStream) {
        mediaStream.getTracks().forEach((t) => t.stop());
      }

      mediaStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: useFrontCamera ? "user" : "environment",
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: true
      });

      preview.srcObject = mediaStream;
      preview.classList.toggle("mirrored", useFrontCamera);
    };

    // -----------------------------
    // Event bindings – State
    // -----------------------------
    document.getElementById("btnPrevQ").addEventListener("click", () => quizState.prevQuestion());
    document.getElementById("btnNextQ").addEventListener("click", () => quizState.nextQuestion());
    document.getElementById("btnMarkAnswered").addEventListener("click", () => quizState.markCurrentAsAnswered());
    document.getElementById("btnToggleRecord").addEventListener("click", () => quizState.toggleRecordingPermission());
    document.getElementById("btnResetState").addEventListener("click", () => quizState.reset());

    // -----------------------------
    // Event bindings – Video
    // -----------------------------
    btnInit.addEventListener("click", async () => {
      try {
        await initCamera();
        log("Đã xin quyền camera/mic thành công.");
        btnFlip.disabled = false;
        syncRecordingButton();
      } catch (error) {
        log("Lỗi camera: " + error.message);
      }
    });

    btnFlip.addEventListener("click", async () => {
      useFrontCamera = !useFrontCamera;
      await initCamera();
      log("Đã đổi camera.");
    });

    btnStart.addEventListener("click", () => {
      const { isRecordingAllowed } = quizState.getState();

      if (!isRecordingAllowed) {
        log("Lỗi: State hiện không cho phép ghi.");
        return;
      }

      if (!mediaStream) {
        log("Lỗi: Chưa xin quyền camera.");
        return;
      }

      chunks = [];
      recordedBlob = null;
      downloadLink.innerHTML = "";

      let mimeType = "";
      if (MediaRecorder.isTypeSupported("video/webm;codecs=vp9,opus")) {
        mimeType = "video/webm;codecs=vp9,opus";
      } else if (MediaRecorder.isTypeSupported("video/webm;codecs=vp8,opus")) {
        mimeType = "video/webm;codecs=vp8,opus";
      } else if (MediaRecorder.isTypeSupported("video/webm")) {
        mimeType = "video/webm";
      }

      mediaRecorder = new MediaRecorder(
        mediaStream,
        mimeType ? { mimeType } : undefined
      );

      mediaRecorder.addEventListener("dataavailable", (event) => {
        if (event.data.size > 0) chunks.push(event.data);
      });

      mediaRecorder.addEventListener("start", () => {
        log("Bắt đầu ghi...");
      });

      mediaRecorder.addEventListener("stop", () => {
        recordedBlob = new Blob(chunks, { type: "video/webm" });
        playback.src = URL.createObjectURL(recordedBlob);
        btnUpload.disabled = false;

        const sizeMB = (recordedBlob.size / 1024 / 1024).toFixed(2);
        log(`Đã dừng ghi. Kích thước file: ${sizeMB} MB.`);

        const localLink = document.createElement("a");
        localLink.href = playback.src;
        localLink.download = `recorded_${Date.now()}.webm`;
        localLink.textContent = "Tải video về máy";
        downloadLink.appendChild(localLink);
      });

      mediaRecorder.start(100);
      btnStart.disabled = true;
      btnStop.disabled = false;
    });

    btnStop.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
      btnStop.disabled = true;
      syncRecordingButton();
    });

    btnUpload.addEventListener("click", async () => {
      if (!recordedBlob) {
        log("Chưa có video để upload.");
        return;
      }

      const form = new FormData();
      form.append("file", recordedBlob, `client_${Date.now()}.webm`);

      try {
        const response = await fetch("/api/upload", {
          method: "POST",
          body: form
        });
        const data = await response.json();

        log("Upload thành công → " + data.filename);

        if (data.url) {
          const br = document.createElement("br");
          const link = document.createElement("a");
          link.href = data.url;
          link.target = "_blank";
          link.textContent = "Mở video trên server";
          downloadLink.appendChild(br);
          downloadLink.appendChild(link);
        }
      } catch (error) {
        log("Upload lỗi: " + error.message);
      }
    });

    // -----------------------------
    // Khởi tạo ban đầu
    // -----------------------------
    updateStateDisplay();
    syncRecordingButton();
    log("State đã sẵn sàng.");
  </script>
</body>
</html>
